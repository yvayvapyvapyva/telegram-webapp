<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Yandex Map Paint</title>
    
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ API –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç -->
    <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=" type="text/javascript"></script>

    <style>
        :root {
            --primary: #007AFF;
            --danger: #FF3B30;
            --bg-panel: rgba(255, 255, 255, 0.92);
        }

        html, body {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
            overflow: hidden;
            background: #000;
            font-family: -apple-system, system-ui, sans-serif;
        }

        #map {
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ —Å—Ç–∏–ª–µ iOS */
        #toolbar {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            background: var(--bg-panel);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 8px 16px;
            border-radius: 40px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            border: 0.5px solid rgba(0,0,0,0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn {
            border: none;
            background: none;
            padding: 10px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            color: #000;
            transition: 0.2s;
            white-space: nowrap;
        }

        .btn:active {
            opacity: 0.6;
            transform: scale(0.95);
        }

        .btn-draw.active {
            background: var(--primary);
            color: #fff;
        }

        .btn-clear {
            color: var(--danger);
        }

        .color-picker {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.1);
            padding: 0;
            overflow: hidden;
            cursor: pointer;
        }

        input[type="color"] {
            border: none;
            width: 140%;
            height: 140%;
            margin: -20%;
            cursor: pointer;
        }

        /* –û–≤–µ—Ä–ª–µ–π –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è */
        #paint-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 50;
            display: none;
            touch-action: none; /* –í–∞–∂–Ω–æ –¥–ª—è iPad: –æ—Ç–∫–ª—é—á–∞–µ—Ç –ø—Ä–æ–∫—Ä—É—Ç–∫—É –ø—Ä–∏ —Ä–∏—Å–æ–≤–∞–Ω–∏–∏ */
        }

        #paint-canvas.active {
            display: block;
            cursor: crosshair;
        }

        .instructions {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            background: rgba(0,0,0,0.6);
            color: #fff;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 13px;
            pointer-events: none;
            opacity: 0;
            transition: 0.3s;
        }

        .instructions.visible {
            opacity: 1;
        }
    </style>
</head>
<body>

    <div id="toolbar">
        <div class="color-picker">
            <input type="color" id="strokeColor" value="#FF3B30">
        </div>
        <button id="toggleDraw" class="btn btn-draw">
            <span>‚úèÔ∏è</span> –†–∏—Å–æ–≤–∞—Ç—å
        </button>
        <button id="clearAll" class="btn btn-clear">
            <span>üóëÔ∏è</span> –û—á–∏—Å—Ç–∏—Ç—å
        </button>
    </div>

    <div id="instructions" class="instructions">–†–∏—Å—É–π—Ç–µ –ø–∞–ª—å—Ü–µ–º –ø–æ–≤–µ—Ä—Ö –∫–∞—Ä—Ç—ã</div>

    <canvas id="paint-canvas"></canvas>
    <div id="map"></div>

    <script type="text/javascript">
        ymaps.ready(init);

        function init() {
            const map = new ymaps.Map("map", {
                center: [55.753215, 37.622504],
                zoom: 12,
                type: 'yandex#satellite',
                controls: [] // –ú–∏–Ω–∏–º–∞–ª–∏–∑–º –¥–ª—è iPad
            }, {
                suppressMapOpenBlock: true
            });

            const canvas = document.getElementById('paint-canvas');
            const ctx = canvas.getContext('2d');
            const toggleBtn = document.getElementById('toggleDraw');
            const clearBtn = document.getElementById('clearAll');
            const colorInput = document.getElementById('strokeColor');
            const instructions = document.getElementById('instructions');

            let isDrawingMode = false;
            let isDrawing = false;
            let currentPath = [];
            const drawnLayers = [];

            // –ü–æ–¥–≥–æ–Ω—è–µ–º —Ä–∞–∑–º–µ—Ä —Ö–æ–ª—Å—Ç–∞ –ø–æ–¥ —ç–∫—Ä–∞–Ω
            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();

            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞
            toggleBtn.onclick = () => {
                isDrawingMode = !isDrawingMode;
                canvas.classList.toggle('active', isDrawingMode);
                toggleBtn.classList.toggle('active', isDrawingMode);
                instructions.classList.toggle('visible', isDrawingMode);
                
                // –ë–ª–æ–∫–∏—Ä—É–µ–º/—Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É
                if (isDrawingMode) {
                    map.behaviors.disable(['drag', 'scrollZoom', 'multiTouch']);
                } else {
                    map.behaviors.enable(['drag', 'scrollZoom', 'multiTouch']);
                }
            };

            // –õ–æ–≥–∏–∫–∞ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ —Ä–∏—Å–æ–≤–∞–Ω–∏—è
            const startPosition = (e) => {
                if (!isDrawingMode) return;
                isDrawing = true;
                currentPath = [];
                const pos = getPos(e);
                ctx.beginPath();
                ctx.moveTo(pos.x, pos.y);
                currentPath.push(map.options.get('projection').fromGlobalPixels(
                    map.converter.pageToGlobal([pos.x, pos.y]),
                    map.getZoom()
                ));
            };

            const draw = (e) => {
                if (!isDrawing || !isDrawingMode) return;
                const pos = getPos(e);
                
                ctx.lineWidth = 4;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.strokeStyle = colorInput.value;

                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();

                // –°–æ–±–∏—Ä–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ –Ω–∞ –∫–∞—Ä—Ç—É
                const coords = map.options.get('projection').fromGlobalPixels(
                    map.converter.pageToGlobal([pos.x, pos.y]),
                    map.getZoom()
                );
                currentPath.push(coords);
            };

            const stopPosition = () => {
                if (!isDrawing) return;
                isDrawing = false;
                ctx.closePath();
                
                // –ü–µ—Ä–µ–Ω–æ—Å–∏–º —Ä–∏—Å—É–Ω–æ–∫ —Å –∫–∞–Ω–≤–∞—Å–∞ –Ω–∞ –∫–∞—Ä—Ç—É –∫–∞–∫ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç
                if (currentPath.length > 1) {
                    const polyline = new ymaps.Polyline(currentPath, {}, {
                        strokeColor: colorInput.value,
                        strokeWidth: 4,
                        strokeOpacity: 0.8
                    });
                    map.geoObjects.add(polyline);
                    drawnLayers.push(polyline);
                }
                
                // –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ö–æ–ª—Å—Ç, —Ç–∞–∫ –∫–∞–∫ –ª–∏–Ω–∏—è —Ç–µ–ø–µ—Ä—å –Ω–∞ –∫–∞—Ä—Ç–µ
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            };

            function getPos(e) {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return {
                    x: clientX - rect.left,
                    y: clientY - rect.top
                };
            }

            // –°–æ–±—ã—Ç–∏—è —Ç–∞—á–∞ (iPad) –∏ –º—ã—à–∏
            canvas.addEventListener('mousedown', startPosition);
            canvas.addEventListener('mousemove', draw);
            window.addEventListener('mouseup', stopPosition);

            canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startPosition(e); });
            canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e); });
            canvas.addEventListener('touchend', stopPosition);

            // –û—á–∏—Å—Ç–∫–∞
            clearBtn.onclick = () => {
                map.geoObjects.removeAll();
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            };
        }
    </script>
</body>
</html>
