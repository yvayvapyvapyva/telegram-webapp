<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>Редактор маршрутов</title>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=YANDEX_API_KEY&lang=ru_RU"></script>
    <style>
        body, html { margin: 0; height: 100%; font-family: 'Inter', Arial, sans-serif; overflow: hidden; }
        #map { position: absolute; inset: 0; }
        
        #panel { 
            position: absolute; top: 10px; right: 10px; width: 300px; z-index: 1000;
            background: rgba(255,255,255,0.9); padding: 15px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); backdrop-filter: blur(10px);
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        #panel.collapsed { transform: translateX(320px); opacity: 0; pointer-events: none; }
        
        #togglePanel {
            position: absolute; top: 10px; right: 10px; z-index: 1001;
            width: 40px; height: 40px; border-radius: 8px; border: none;
            background: #2f80ed; color: white; font-size: 20px; cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .info { background: #f4f4f7; padding: 10px; border-radius: 8px; margin-bottom: 8px; font-size: 13px; color: #666; line-height: 1.4; }
        .row { display: flex; gap: 8px; margin-bottom: 8px; }
        button { flex: 1; cursor: pointer; border: none; border-radius: 8px; padding: 10px; background: #2f80ed; color: white; font-weight: bold; }
        button.danger { background: #e74c3c; }
        button.secondary { background: #6c757d; }
        
        textarea { 
            flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; 
            outline: none; font-size: 14px; font-family: inherit; resize: none; 
            overflow: hidden; min-height: 40px; width: 100%;
        }
        
        #palette { display: flex; gap: 6px; margin-top: 5px; }
        #palette div { width: 25px; height: 25px; border-radius: 5px; cursor: pointer; border: 1px solid #ccc; }
        .point-id-label { color: #2f80ed; font-weight: bold; margin-bottom: 4px; display: block; }

        .cmd-bubble {
            position: relative; background: #ffffff; border: 2px solid #333;
            border-radius: 6px; padding: 4px 8px; font-size: 12px;
            font-weight: bold; color: #000; box-shadow: 2px 2px 6px rgba(0,0,0,0.3);
            display: inline-block; min-width: 20px; max-width: 250px; 
            word-wrap: break-word; white-space: normal; line-height: 1.3;
        }
    </style>
</head>
<body>

<div id="map"></div>
<button id="togglePanel" onclick="document.getElementById('panel').classList.toggle('collapsed')">≡</button>

<div id="panel">
    <div class="row">
        <button onclick="rotate(-10)">⟲ -10°</button>
        <button onclick="rotate(10)">⟳ +10°</button>
    </div>
    <div class="row">
        <textarea id="cmdInput" placeholder="Команда точки..." oninput="autoResize(this)" onblur="saveCmd()"></textarea>
    </div>
    <div class="info" id="coordsInfo">Выберите точку на карте</div>
    <div class="row" style="margin-bottom: 12px;"><div id="palette"></div></div>
    <button class="secondary" style="width:100%; margin-bottom: 8px;" onclick="toggleLabels()">Показать/скрыть команды</button>
    <button class="danger" style="width:100%" onclick="removePoint()">Удалить точку</button>
    <div class="row" style="margin-top:10px; border-top: 1px solid #eee; padding-top: 10px;">
        <button onclick="exportJSON()" style="background:#555">Экспорт</button>
        <button onclick="importJSON()" style="background:#555">Импорт</button>
    </div>
</div>

<script>
let map, points = [], current = null, showLabels = false, userMarker = null;
const COLOR_PALETTE = ['Gold', 'blue', 'red', 'Lime', 'Fuchsia', 'purple', 'Silver', 'Aqua'];

ymaps.ready(() => {
    map = new ymaps.Map("map", { 
        center: [56.3399, 43.9332], 
        zoom: 18, 
        type: 'yandex#satellite', 
        controls: [] 
    });
    
    map.events.add('click', e => addPoint(e.get('coords')));
    
    const pal = document.getElementById('palette');
    COLOR_PALETTE.forEach(c => {
        const d = document.createElement('div');
        d.style.background = c;
        d.onclick = () => { if(current) { current.color = c; updateMarkers(); } };
        pal.appendChild(d);
    });

    initLocationTracking();
});

// Отслеживание местоположения
function initLocationTracking() {
    if ("geolocation" in navigator) {
        navigator.geolocation.watchPosition((position) => {
            const coords = [position.coords.latitude, position.coords.longitude];
            if (!userMarker) {
                userMarker = new ymaps.Placemark(coords, {}, {
                    preset: 'islands#geolocationIcon',
                    zIndex: 2000
                });
                map.geoObjects.add(userMarker);
            } else {
                userMarker.geometry.setCoordinates(coords);
            }
        }, err => console.log(err), { enableHighAccuracy: true });
    }
}

function autoResize(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }

function getIcon(azimuth, colorName, isSelected, id) {
    const fill = colorName || 'Gold';
    const stroke = isSelected ? '#2ecc71' : '#000';
    const sWidth = isSelected ? 3 : 1.5;
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(
        `<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40">
            <g transform="rotate(${azimuth},20,20)">
                <polygon points="20,2 35,35 20,26 5,35" fill="${fill}" stroke="${stroke}" stroke-width="${sWidth}"/>
            </g>
            <circle cx="20" cy="20" r="9" fill="white" stroke="${stroke}" stroke-width="1"/>
            <text x="20" y="24" font-size="12" font-family="Arial, sans-serif" font-weight="900" text-anchor="middle" fill="black">${id}</text>
        </svg>`
    );
}

function addPoint(coords) {
    document.getElementById('panel').classList.remove('collapsed');
    const p = {
        id: points.length + 1,
        lat: coords[0].toFixed(6), lon: coords[1].toFixed(6),
        azimuth: 0, color: 'Gold', command: '', pm: null
    };

    p.pm = new ymaps.Placemark(coords, { iconContent: "" }, {
        iconLayout: 'default#imageWithContent', 
        iconImageSize: [40, 40], iconImageOffset: [-20, -20], draggable: true,
        iconImageHref: getIcon(0, 'Gold', false, p.id),
        iconContentOffset: [25, -10],
        iconContentLayout: ymaps.templateLayoutFactory.createClass(
            '{% if properties.iconContent %}<div class="cmd-bubble">$[properties.iconContent]</div>{% endif %}'
        )
    });

    p.pm.events.add('click', () => selectPoint(p));
    p.pm.events.add('dragend', () => {
        const c = p.pm.geometry.getCoordinates();
        p.lat = c[0].toFixed(6); p.lon = c[1].toFixed(6);
        updateUI();
    });

    map.geoObjects.add(p.pm);
    points.push(p);
    selectPoint(p);
}

function selectPoint(p) {
    saveCmd();
    current = p;
    const input = document.getElementById('cmdInput');
    input.value = p.command;
    autoResize(input);
    updateMarkers();
    updateUI();
}

function saveCmd() { 
    if (current) { 
        current.command = document.getElementById('cmdInput').value.trim(); 
        if(showLabels) current.pm.properties.set('iconContent', current.command);
        updateUI(); 
    } 
}

function toggleLabels() {
    showLabels = !showLabels;
    points.forEach(p => p.pm.properties.set('iconContent', showLabels ? p.command : ""));
}

function reindexPoints() {
    points.forEach((p, index) => p.id = index + 1);
    updateMarkers();
    updateUI();
}

function updateMarkers() {
    points.forEach(p => p.pm.options.set('iconImageHref', getIcon(p.azimuth, p.color, p === current, p.id)));
}

function updateUI() {
    const info = document.getElementById('coordsInfo');
    if (!current) { info.innerText = "Выберите точку"; return; }
    info.innerHTML = `<span class="point-id-label">ID: ${current.id}</span>${current.lat}, ${current.lon}<br>Угол: ${current.azimuth}°`;
}

function rotate(deg) {
    if (!current) return;
    current.azimuth = (current.azimuth + deg + 360) % 360;
    updateMarkers(); updateUI();
}

function removePoint() {
    if (!current) return;
    map.geoObjects.remove(current.pm);
    points = points.filter(p => p !== current);
    current = null;
    reindexPoints();
}

function exportJSON() {
    saveCmd();
    const data = points.map(p => ({ id: p.id, lat: p.lat, lon: p.lon, azimuth: p.azimuth, color: p.color, command: p.command }));
    const b = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'route.json'; a.click();
}

function importJSON() {
    const input = document.createElement('input'); input.type = 'file';
    input.onchange = e => {
        const reader = new FileReader();
        reader.onload = () => {
            const data = JSON.parse(reader.result);
            points.forEach(p => map.geoObjects.remove(p.pm));
            points = [];
            data.forEach(d => {
                addPoint([parseFloat(d.lat), parseFloat(d.lon)]);
                const last = points[points.length - 1];
                last.azimuth = d.azimuth || 0; last.color = d.color || 'Gold'; last.command = d.command || '';
            });
            reindexPoints();
            if(showLabels) { showLabels = false; toggleLabels(); }
        };
        reader.readAsText(e.target.files[0]);
    };
    input.click();
}
</script>
</body>
</html>
