<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>GPS + Азимут (исправлено)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://api-maps.yandex.ru/2.1/?apikey=ВАШ_API_КЛЮЧ&lang=ru_RU"></script>

<style>
html, body, #map {
    width: 100%;
    height: 100%;
    margin: 0;
}

.arrow {
    width: 40px;
    height: 40px;
    transform-origin: center center;
}
.arrow svg {
    width: 100%;
    height: 100%;
}
</style>
</head>
<body>

<div id="map"></div>

<script>
let map, placemark, arrowEl;

ymaps.ready(init);

function init() {
    map = new ymaps.Map("map", {
        center: [55.751574, 37.573856],
        zoom: 17
    });

    placemark = new ymaps.Placemark(
        map.getCenter(),
        {},
        {
            iconLayout: 'default#html',
            iconHTML: `
                <div class="arrow">
                    <svg viewBox="0 0 100 100">
                        <polygon points="50,0 90,100 50,75 10,100" fill="red"/>
                    </svg>
                </div>
            `,
            iconOffset: [-20, -20]
        }
    );

    map.geoObjects.add(placemark);

    // Получаем DOM элемент стрелки
    placemark.events.add('add', () => {
        arrowEl = placemark.getOverlay().getElement().querySelector('.arrow');
    });

    watchLocation();
    watchAzimuth();
}

// GPS
function watchLocation() {
    navigator.geolocation.watchPosition(pos => {
        const coords = [pos.coords.latitude, pos.coords.longitude];
        placemark.geometry.setCoordinates(coords);
        map.setCenter(coords, map.getZoom(), { duration: 200 });
    }, console.error, { enableHighAccuracy: true });
}

// Азимут
function watchAzimuth() {

    if (typeof DeviceOrientationEvent === 'undefined') return;

    // iOS
    if (DeviceOrientationEvent.requestPermission) {
        DeviceOrientationEvent.requestPermission().then(res => {
            if (res === 'granted') {
                window.addEventListener('deviceorientation', handleOrientation, true);
            }
        });
    } else {
        // Android
        window.addEventListener('deviceorientationabsolute', handleOrientation, true);
        window.addEventListener('deviceorientation', handleOrientation, true);
    }
}

function handleOrientation(e) {
    let heading;

    // iOS
    if (e.webkitCompassHeading !== undefined) {
        heading = e.webkitCompassHeading;
    }
    // Android
    else if (e.alpha !== null) {
        heading = 360 - e.alpha;
    }

    if (heading !== undefined && arrowEl) {
        arrowEl.style.transform = `rotate(${heading}deg)`;
    }
}
</script>

</body>
</html>
