<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>GPS + Поворот карты</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://api-maps.yandex.ru/2.1/?apikey=ВАШ_API_КЛЮЧ&lang=ru_RU"></script>

<style>
html, body, #map {
    width: 100%;
    height: 100%;
    margin: 0;
}
</style>
</head>
<body>

<div id="map"></div>

<script>
let map, placemark;

ymaps.ready(init);

function init() {
    map = new ymaps.Map("map", {
        center: [55.751574, 37.573856],
        zoom: 18,
        controls: []
    });

    // Стрелка всегда "вверх"
    const svgArrow = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
            <polygon points="50,0 90,100 50,75 10,100" fill="red"/>
        </svg>
    `;

    placemark = new ymaps.Placemark(
        map.getCenter(),
        {},
        {
            iconLayout: 'default#image',
            iconImageHref: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svgArrow),
            iconImageSize: [40, 40],
            iconImageOffset: [-20, -20]
        }
    );

    map.geoObjects.add(placemark);

    watchLocation();
    watchAzimuth();
}

// GPS
function watchLocation() {
    navigator.geolocation.watchPosition(pos => {
        const coords = [pos.coords.latitude, pos.coords.longitude];
        placemark.geometry.setCoordinates(coords);
        map.setCenter(coords, map.getZoom(), { duration: 100 });
    }, console.error, { enableHighAccuracy: true });
}

// Азимут → поворот карты
function watchAzimuth() {
    if (typeof DeviceOrientationEvent === 'undefined') return;

    if (DeviceOrientationEvent.requestPermission) {
        // iOS
        DeviceOrientationEvent.requestPermission().then(res => {
            if (res === 'granted') {
                window.addEventListener('deviceorientation', handleOrientation, true);
            }
        });
    } else {
        // Android
        window.addEventListener('deviceorientationabsolute', handleOrientation, true);
        window.addEventListener('deviceorientation', handleOrientation, true);
    }
}

function handleOrientation(e) {
    let heading;

    // iOS
    if (e.webkitCompassHeading !== undefined) {
        heading = e.webkitCompassHeading;
    }
    // Android
    else if (e.alpha !== null) {
        heading = 360 - e.alpha;
    }

    if (heading !== undefined) {
        map.setBearing(heading, { duration: 100 });
    }
}
</script>

</body>
</html>
