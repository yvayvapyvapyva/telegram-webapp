<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>–†–µ–¥–∞–∫—Ç–æ—Ä –º–∞—Ä—à—Ä—É—Ç–æ–≤ (GitHub Auto)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://api-maps.yandex.ru/2.1/?apikey=YANDEX_API_KEY&lang=ru_RU"></script>
    <style>
        body, html { margin: 0; height: 100%; font-family: 'Inter', Arial, sans-serif; overflow: hidden; }
        #map { position: absolute; inset: 0; }
        #panel { 
            position: absolute; top: 10px; right: 10px; width: 300px; z-index: 1000;
            background: rgba(255,255,255,0.9); padding: 15px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); backdrop-filter: blur(10px);
            transition: transform 0.3s ease, opacity 0.3s ease;
            max-height: 90vh; overflow-y: auto;
        }
        #togglePanel {
            position: absolute; bottom: 25px; right: 20px; z-index: 1001;
            width: 50px; height: 50px; border-radius: 25px; border: none;
            background: #2f80ed; color: white; font-size: 24px; cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;
        }
        .info { background: #f4f4f7; padding: 10px; border-radius: 8px; margin-bottom: 8px; font-size: 12px; color: #444; line-height: 1.2; }
        .row { display: flex; gap: 8px; margin-bottom: 8px; }
        button { 
            flex: 1; cursor: pointer; border: none; border-radius: 8px; padding: 10px 5px; 
            background: #2f80ed; color: white; font-weight: bold; font-family: inherit;
            min-height: 44px; display: flex; align-items: center; justify-content: center;
        }
        button.danger { background: #e74c3c; }
        button.secondary { background: #6c757d; }
        button.add-btn { background: #28a745; max-width: 44px; font-size: 20px; }
        button.gh-btn { background: #24292e; font-size: 12px; } 
        textarea, .gh-input, select { 
            flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; 
            outline: none; font-size: 14px; font-family: inherit; width: 100%; box-sizing: border-box;
        }
        #palette { display: flex; gap: 6px; margin-top: 5px; overflow-x: auto; padding: 5px 2px; }
        #palette div { min-width: 28px; height: 28px; border-radius: 6px; cursor: pointer; border: 1px solid #ccc; flex-shrink: 0; }
        .cmd-bubble {
            position: relative; background: #ffffff; border: 2px solid #333;
            border-radius: 6px; padding: 4px 8px; font-size: 12px;
            font-weight: bold; color: #000; box-shadow: 2px 2px 6px rgba(0,0,0,0.3);
            display: inline-block; min-width: 20px; max-width: 200px; 
            word-wrap: break-word; white-space: normal; line-height: 1.3;
        }
    </style>
</head>
<body>

<div id="map"></div>
<button id="togglePanel" onclick="document.getElementById('panel').classList.toggle('collapsed')">‚â°</button>

<div id="panel">
    <div class="row">
        <button onclick="rotate(-10)">‚ü≤ -10¬∞</button>
        <button onclick="rotate(10)">‚ü≥ +10¬∞</button>
    </div>
    <div class="row">
        <textarea id="cmdInput" placeholder="–ö–æ–º–∞–Ω–¥–∞ —Ç–æ—á–∫–∏..." oninput="autoResize(this)" onblur="saveCmd()"></textarea>
    </div>
    
    <div class="info">
        <input type="password" id="ghToken" class="gh-input" placeholder="GitHub Token" style="margin-bottom: 5px;" oninput="saveToken(this.value)">
        <div class="row">
            <select id="fileSelector" onchange="loadFromGitHub(this.value)">
                <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤...</option>
            </select>
            <button class="add-btn" onclick="createNewFile()" title="–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ñ–∞–π–ª">+</button>
        </div>
    </div>

    <div id="coordsInfo" class="info">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É</div>
    <div class="row" style="margin-bottom: 5px;"><div id="palette"></div></div>
    
    <div class="row">
        <button class="secondary" onclick="toggleLabels()">üëÅÔ∏è</button>
        <button class="danger" onclick="removePoint()">üóëÔ∏è</button>
        <button class="secondary" onclick="exportJSON()">üíæ</button>
        <button class="secondary" onclick="importJSON()">üìÇ</button>
    </div>
    <div class="row">
        <button class="gh-btn" style="background:#28a745" onclick="saveToGitHub()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ GitHub</button>
    </div>
</div>

<script>
const GH_REPO = "yvayvapyvapyva/test";
const GH_PATH = "roads";

let map, points = [], current = null, showLabels = false, currentFileSha = null, selectedFilePath = null;
const COLOR_PALETTE = ['Gold', 'blue', 'red', 'Lime', 'Fuchsia', 'purple', 'Silver', 'Aqua'];

ymaps.ready(() => {
    map = new ymaps.Map("map", { center: [56.3399, 43.9332], zoom: 18, type: 'yandex#satellite', controls: [] });
    map.events.add('click', e => addPoint(e.get('coords')));
    
    const pal = document.getElementById('palette');
    COLOR_PALETTE.forEach(c => {
        const d = document.createElement('div');
        d.style.background = c;
        d.onclick = () => { if(current) { current.color = c; updateMarkers(); } };
        pal.appendChild(d);
    });

    initApp();
});

function initApp() {
    const savedToken = localStorage.getItem('gh_token');
    if (savedToken) {
        document.getElementById('ghToken').value = savedToken;
        listGitHubFiles(savedToken);
    }
}

function saveToken(val) {
    localStorage.setItem('gh_token', val);
    if (val.length > 10) listGitHubFiles(val);
}

async function createNewFile() {
    const token = document.getElementById('ghToken').value;
    if (!token) return alert("–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω!");
    
    let fileName = prompt("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –Ω–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞ (–±–µ–∑ .json):");
    if (!fileName) return;
    if (!fileName.endsWith('.json')) fileName += '.json';
    
    const fullPath = `${GH_PATH}/${fileName}`;
    const initialData = btoa(unescape(encodeURIComponent(JSON.stringify([], null, 2))));

    try {
        const res = await fetch(`https://api.github.com/repos/${GH_REPO}/contents/${fullPath}`, {
            method: 'PUT',
            headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: "Create new route file",
                content: initialData
            })
        });

        if (res.ok) {
            alert("–§–∞–π–ª —Å–æ–∑–¥–∞–Ω!");
            await listGitHubFiles(token);
            document.getElementById('fileSelector').value = fullPath;
            loadFromGitHub(fullPath);
        } else {
            const err = await res.json();
            alert("–û—à–∏–±–∫–∞: " + err.message);
        }
    } catch (e) { alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ñ–∞–π–ª–∞"); }
}

async function listGitHubFiles(token) {
    const sel = document.getElementById('fileSelector');
    try {
        const res = await fetch(`https://api.github.com/repos/${GH_REPO}/contents/${GH_PATH}`, { 
            headers: { 'Authorization': `token ${token}` } 
        });
        if (!res.ok) throw new Error();
        const files = await res.json();
        sel.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª...</option>';
        files.filter(f => f.name.endsWith('.json')).forEach(f => {
            const o = document.createElement('option'); o.value = f.path; o.textContent = f.name; sel.appendChild(o);
        });
    } catch (e) { sel.innerHTML = '<option value="">–û—à–∏–±–∫–∞ —Ç–æ–∫–µ–Ω–∞</option>'; }
}

function getIcon(azimuth, colorName, isSelected, id) {
    const fill = colorName || 'Gold';
    const stroke = isSelected ? '#2ecc71' : '#000';
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(
        `<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40">
            <g transform="rotate(${azimuth},20,20)">
                <polygon points="20,2 35,35 20,26 5,35" fill="${fill}" stroke="${stroke}" stroke-width="${isSelected?3:1.5}"/>
            </g>
            <circle cx="20" cy="20" r="9" fill="white" stroke="${fill}" stroke-width="2"/>
            <text x="20" y="24" font-size="11" font-family="Arial" font-weight="900" text-anchor="middle" fill="black">${id}</text>
        </svg>`
    );
}

function addPoint(coords) {
    const p = { id: points.length + 1, lat: coords[0].toFixed(6), lon: coords[1].toFixed(6), azimuth: 0, color: 'Gold', command: '', pm: null };
    p.pm = new ymaps.Placemark(coords, { iconContent: "" }, {
        iconLayout: 'default#imageWithContent', iconImageSize: [40, 40], iconImageOffset: [-20, -20], draggable: true,
        iconImageHref: getIcon(0, 'Gold', false, p.id), iconContentOffset: [25, -10],
        iconContentLayout: ymaps.templateLayoutFactory.createClass('{% if properties.iconContent %}<div class="cmd-bubble">$[properties.iconContent]</div>{% endif %}')
    });
    p.pm.events.add('click', () => selectPoint(p));
    p.pm.events.add('dragend', () => {
        const c = p.pm.geometry.getCoordinates();
        p.lat = c[0].toFixed(6); p.lon = c[1].toFixed(6);
        updateUI();
    });
    map.geoObjects.add(p.pm);
    points.push(p);
    selectPoint(p);
    return p;
}

function selectPoint(p) {
    if (current && current !== p) saveCmd();
    current = p;
    document.getElementById('cmdInput').value = p.command;
    autoResize(document.getElementById('cmdInput'));
    updateMarkers();
    updateUI();
}

function saveCmd() { 
    if (current) { 
        current.command = document.getElementById('cmdInput').value.trim(); 
        current.pm.properties.set('iconContent', showLabels ? current.command : "");
    } 
}

function toggleLabels() {
    showLabels = !showLabels;
    points.forEach(p => p.pm.properties.set('iconContent', showLabels ? p.command : ""));
}

function updateMarkers() {
    points.forEach(p => p.pm.options.set('iconImageHref', getIcon(p.azimuth, p.color, p === current, p.id)));
}

function updateUI() {
    if (current) document.getElementById('coordsInfo').innerHTML = `<b>ID:${current.id}</b> | ‚à†${current.azimuth}¬∞`;
}

function rotate(deg) {
    if (current) { current.azimuth = (current.azimuth + deg + 360) % 360; updateMarkers(); updateUI(); }
}

function removePoint() {
    if (!current) return;
    map.geoObjects.remove(current.pm);
    points = points.filter(p => p !== current);
    current = null;
    points.forEach((p, i) => { 
        p.id = i + 1; 
        p.pm.options.set('iconImageHref', getIcon(p.azimuth, p.color, false, p.id)); 
    });
}

async function loadFromGitHub(path) {
    if (!path) return;
    const token = document.getElementById('ghToken').value;
    try {
        const res = await fetch(`https://api.github.com/repos/${GH_REPO}/contents/${path}`, { 
            headers: { 'Authorization': `token ${token}` } 
        });
        const data = await res.json();
        currentFileSha = data.sha;
        selectedFilePath = path;
        const json = JSON.parse(decodeURIComponent(escape(atob(data.content))));
        
        points.forEach(p => map.geoObjects.remove(p.pm));
        points = [];
        
        json.forEach((d, index) => {
            const p = {
                id: d.id || (index + 1),
                lat: d.lat, lon: d.lon, 
                azimuth: d.azimuth || 0, color: d.color || 'Gold', command: d.command || ''
            };
            p.pm = new ymaps.Placemark([parseFloat(p.lat), parseFloat(p.lon)], { iconContent: showLabels ? p.command : "" }, {
                iconLayout: 'default#imageWithContent', iconImageSize: [40, 40], iconImageOffset: [-20, -20], draggable: true,
                iconImageHref: getIcon(p.azimuth, p.color, false, p.id),
                iconContentOffset: [25, -10],
                iconContentLayout: ymaps.templateLayoutFactory.createClass('{% if properties.iconContent %}<div class="cmd-bubble">$[properties.iconContent]</div>{% endif %}')
            });
            p.pm.events.add('click', () => selectPoint(p));
            map.geoObjects.add(p.pm);
            points.push(p);
        });
        if (points.length > 0) selectPoint(points[0]);
        else { current = null; document.getElementById('cmdInput').value = ''; updateUI(); }
    } catch (e) { alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏"); }
}

async function saveToGitHub() {
    if (!selectedFilePath) return alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª!");
    saveCmd();
    const token = document.getElementById('ghToken').value;
    const data = points.map(p => ({ id: p.id, lat: p.lat, lon: p.lon, azimuth: p.azimuth, color: p.color, command: p.command }));
    const body = {
        message: "Update route",
        content: btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2)))),
        sha: currentFileSha
    };
    try {
        const res = await fetch(`https://api.github.com/repos/${GH_REPO}/contents/${selectedFilePath}`, {
            method: 'PUT', headers: { 'Authorization': `token ${token}` }, body: JSON.stringify(body)
        });
        const resData = await res.json();
        currentFileSha = resData.content.sha;
        alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");
    } catch (e) { alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è"); }
}

function autoResize(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }

function exportJSON() {
    saveCmd();
    const data = points.map(p => ({ id: p.id, lat: p.lat, lon: p.lon, azimuth: p.azimuth, color: p.color, command: p.command }));
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'}));
    a.download = 'route.json'; a.click();
}

function importJSON() {
    const input = document.createElement('input'); input.type = 'file';
    input.onchange = e => {
        const reader = new FileReader();
        reader.onload = () => {
            const json = JSON.parse(reader.result);
            points.forEach(p => map.geoObjects.remove(p.pm));
            points = [];
            json.forEach((d, i) => {
                const p = addPoint([parseFloat(d.lat), parseFloat(d.lon)]);
                p.id = d.id || (i + 1);
                p.azimuth = d.azimuth || 0; p.color = d.color || 'Gold'; p.command = d.command || '';
                p.pm.properties.set('iconContent', showLabels ? p.command : "");
                p.pm.options.set('iconImageHref', getIcon(p.azimuth, p.color, false, p.id));
            });
        };
        reader.readAsText(e.target.files[0]);
    };
    input.click();
}
</script>
</body>
</html>
