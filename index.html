<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>Навигация</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://api-maps.yandex.ru/2.1/?apikey=ВАШ_API_КЛЮЧ&lang=ru_RU"></script>

<style>
html, body {
    margin: 0;
    height: 100%;
}
#map {
    height: 100%;
}
#start {
    position: absolute;
    inset: 0;
    z-index: 20;
    background: black;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
}
#panel {
    position: absolute;
    z-index: 10;
    top: 10px;
    left: 10px;
    right: 10px;
    background: white;
}
textarea {
    width: 100%;
    height: 120px;
    box-sizing: border-box;
}
button {
    width: 100%;
}
</style>
</head>

<body>

<div id="start">Нажмите для запуска</div>

<div id="panel">
<textarea id="input">
56.339941, 43.933242,1-Выполняем параллельную парковку
56.340072, 43.933019,2-Выполняем заезд в гараж
56.340182, 43.932832,3-Выезжаем с парковки направо
</textarea>
<button onclick="showPoints()">Показать точки</button>
</div>

<div id="map"></div>

<script>
let map, placemark;
let azimuth = 0;

// ===== запуск (обязательно для iOS) =====
document.getElementById('start').onclick = async () => {
    document.getElementById('start').remove();

    if (typeof DeviceOrientationEvent?.requestPermission === 'function') {
        await DeviceOrientationEvent.requestPermission();
    }

    initMap();
    initCompass();
    initVoice();
};

// ===== карта и геолокация =====
function initMap() {
    ymaps.ready(() => {
        map = new ymaps.Map("map", {
            center: [0, 0],
            zoom: 18,
            type: 'yandex#satellite',
            controls: []
        });

        placemark = new ymaps.Placemark([0, 0], {}, {
            iconLayout: 'default#image',
            iconImageHref: arrowSVG(0),
            iconImageSize: [40, 40],
            iconImageOffset: [-20, -20]
        });

        map.geoObjects.add(placemark);

        navigator.geolocation.watchPosition(p => {
            const c = [p.coords.latitude, p.coords.longitude];
            placemark.geometry.setCoordinates(c);
            map.setCenter(c);
        }, null, { enableHighAccuracy: true });
    });
}

// ===== компас =====
function initCompass() {

    // iOS — абсолютный азимут
    window.addEventListener('deviceorientation', e => {
        if (e.webkitCompassHeading !== undefined) {
            azimuth = Math.round(e.webkitCompassHeading);
            updateArrow();
        }
    }, true);

    // Android — ТОЛЬКО абсолютный и только при горизонтальном положении
    window.addEventListener('deviceorientationabsolute', e => {
        if (!e.absolute || e.alpha === null) return;
        if (Math.abs(e.beta) > 45) return; // защита от вертикали

        azimuth = Math.round(360 - e.alpha);
        updateArrow();
    }, true);
}

// ===== обновление стрелки =====
function updateArrow() {
    placemark.options.set(
        'iconImageHref',
        arrowSVG(azimuth)
    );
}

// ===== голос =====
function initVoice() {
    setInterval(() => {
        speechSynthesis.speak(
            new SpeechSynthesisUtterance(`Азимут ${azimuth} градусов`)
        );
    }, 10000);
}

// ===== SVG стрелка =====
function arrowSVG(a) {
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40">
            <g transform="rotate(${a},20,20)">
                <polygon points="20,2 28,30 20,24 12,30" fill="red"/>
            </g>
        </svg>
    `);
}

// ===== точки маршрута =====
function showPoints() {
    const lines = document.getElementById('input').value
        .split('\n')
        .filter(l => l.trim());

    lines.forEach(line => {
        const [lat, lon, rest] = line.split(',');
        const [num, text] = rest.split('-');

        const pm = new ymaps.Placemark(
            [parseFloat(lat), parseFloat(lon)],
            { balloonContent: text },
            {
                preset: 'islands#redCircleIcon',
                iconContent: num
            }
        );

        map.geoObjects.add(pm);
    });
}
</script>

</body>
</html>
