<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>GPS + Азимут на Яндекс Карте</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Яндекс Карты -->
    <script src="https://api-maps.yandex.ru/2.1/?apikey=ВАШ_API_КЛЮЧ&lang=ru_RU"></script>

    <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        .arrow {
            width: 40px;
            height: 40px;
            background: url('data:image/svg+xml;utf8,\
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">\
            <polygon points="50,0 90,100 50,75 10,100" fill="red"/></svg>');
            background-size: cover;
            transform-origin: center center;
        }
    </style>
</head>
<body>

<div id="map"></div>

<script>
let map, marker;
let currentAzimuth = 0;

ymaps.ready(init);

function init() {
    map = new ymaps.Map("map", {
        center: [55.751574, 37.573856],
        zoom: 16
    });

    marker = new ymaps.Placemark(
        map.getCenter(),
        {},
        {
            iconLayout: 'default#imageWithContent',
            iconImageHref: '',
            iconImageSize: [0, 0],
            iconContentLayout: ymaps.templateLayoutFactory.createClass(
                '<div class="arrow" style="transform: rotate({{properties.azimuth}}deg)"></div>'
            )
        }
    );

    map.geoObjects.add(marker);

    watchLocation();
    watchAzimuth();
}

// GPS
function watchLocation() {
    if (!navigator.geolocation) {
        alert("Геолокация не поддерживается");
        return;
    }

    navigator.geolocation.watchPosition(
        pos => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;

            const coords = [lat, lon];
            marker.geometry.setCoordinates(coords);
            map.setCenter(coords, map.getZoom(), {duration: 300});
        },
        err => alert("Ошибка GPS: " + err.message),
        {
            enableHighAccuracy: true,
            maximumAge: 1000
        }
    );
}

// Азимут
function watchAzimuth() {
    if (typeof DeviceOrientationEvent !== 'undefined') {

        if (DeviceOrientationEvent.requestPermission) {
            // iOS
            DeviceOrientationEvent.requestPermission().then(response => {
                if (response === 'granted') {
                    window.addEventListener('deviceorientation', handleOrientation);
                }
            });
        } else {
            // Android
            window.addEventListener('deviceorientationabsolute', handleOrientation);
        }
    }
}

function handleOrientation(event) {
    if (event.alpha !== null) {
        currentAzimuth = 360 - event.alpha;
        marker.properties.set('azimuth', currentAzimuth);
    }
}
</script>

</body>
</html>
