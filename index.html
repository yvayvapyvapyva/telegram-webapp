<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>Навигация</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://api-maps.yandex.ru/2.1/?apikey=ВАШ_API_КЛЮЧ&lang=ru_RU"></script>

<style>
html, body { margin:0; height:100%; font-family:Arial,sans-serif; }
#map { width:100%; height:100%; }

#start {
    position:absolute; inset:0; z-index:20;
    background:black; color:white;
    display:flex; align-items:center; justify-content:center;
    font-size:20px; cursor:pointer;
}

#togglePanelBtn {
    position:absolute; top:10px; left:10px; z-index:16;
    width:36px; height:36px; font-size:20px;
    background:white; border:none; border-radius:6px;
}

#panel {
    position:absolute; top:50px; left:10px; z-index:15;
    width:260px; max-height:80%;
    background:rgba(255,255,255,0.9);
    padding:6px; border-radius:6px;
    display:none; overflow:auto;
}

#panel textarea { width:100%; height:220px; box-sizing:border-box; }
#panel button, #panel input { width:100%; margin-top:5px; }

#info {
    position:absolute; bottom:0; left:0; width:100%;
    background:rgba(255,255,255,0.95);
    padding:8px; box-sizing:border-box;
    font-weight:bold; z-index:15;
}
</style>
</head>
<body>

<div id="start">Нажмите для запуска</div>

<button id="togglePanelBtn">☰</button>

<div id="panel">
<textarea id="input">
56.339941,43.933242,0-Параллельная парковка
56.340072,43.933019,90-Заезд в гараж
56.340182,43.932832,180-Выезд направо
</textarea>

<button onclick="showPoints()">Обновить точки</button>

<label>Дистанция срабатывания (м)</label>
<input id="distanceTrigger" type="number" value="20">

<button id="toggleAutoCenter">Автоцентр: Вкл</button>
</div>

<div id="info">Ожидание GPS…</div>
<div id="map"></div>

<script>
let map, placemark;
let points = [];
let currentIndex = 0;
let azimuth = 0;
let autoCenter = true;
let speechAllowed = false;
let wakeLock = null;

/* ===== Wake Lock ===== */
async function requestWakeLock(){
    if('wakeLock' in navigator){
        wakeLock = await navigator.wakeLock.request('screen');
    }
}
document.addEventListener('visibilitychange', async ()=>{
    if(wakeLock && document.visibilityState==='visible') await requestWakeLock();
});

/* ===== START ===== */
document.getElementById('start').onclick = async ()=>{
    document.getElementById('start').remove();
    speechAllowed = true;
    speechSynthesis.speak(new SpeechSynthesisUtterance(''));
    if(DeviceOrientationEvent?.requestPermission)
        await DeviceOrientationEvent.requestPermission();
    await requestWakeLock();
    initMap();
    initCompass();
};

/* ===== PANEL ===== */
togglePanelBtn.onclick = ()=> {
    panel.style.display = panel.style.display==='block'?'none':'block';
};

toggleAutoCenter.onclick = ()=>{
    autoCenter = !autoCenter;
    toggleAutoCenter.textContent = `Автоцентр: ${autoCenter?'Вкл':'Выкл'}`;
};

/* ===== MAP ===== */
function initMap(){
    ymaps.ready(()=>{
        map = new ymaps.Map("map",{
            center:[0,0], zoom:18,
            type:'yandex#satellite', controls:[]
        });

        placemark = new ymaps.Placemark([0,0],{},{
            iconLayout:'default#image',
            iconImageHref:arrowSVG(0,'red'),
            iconImageSize:[40,40],
            iconImageOffset:[-20,-20]
        });
        map.geoObjects.add(placemark);

        navigator.geolocation.watchPosition(p=>{
            const c=[p.coords.latitude,p.coords.longitude];
            placemark.geometry.setCoordinates(c);
            if(autoCenter) map.setCenter(c);
            checkDistance(c);
        },null,{enableHighAccuracy:true});
    });
}

/* ===== COMPASS ===== */
function initCompass(){
    window.addEventListener('deviceorientation',e=>{
        if(e.webkitCompassHeading!==undefined){
            azimuth=Math.round(e.webkitCompassHeading);
            updateArrow();
        }
    },true);

    window.addEventListener('deviceorientationabsolute',e=>{
        if(!e.absolute||e.alpha===null||Math.abs(e.beta)>45) return;
        azimuth=Math.round(360-e.alpha);
        updateArrow();
    },true);
}

function updateArrow(){
    placemark.options.set('iconImageHref',arrowSVG(azimuth,'red'));
}

/* ===== SVG ===== */
function arrowSVG(a,color,num=null){
    return 'data:image/svg+xml;utf8,'+encodeURIComponent(`
<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40">
<g transform="rotate(${a},20,20)">
<polygon points="20,2 28,30 20,24 12,30" fill="${color}"/>
</g>
${num?`<text x="20" y="30" font-size="14" text-anchor="middle" fill="white">${num}</text>`:''}
</svg>`);
}

/* ===== POINTS ===== */
function showPoints(){
    points.forEach(p=>p.placemark&&map.geoObjects.remove(p.placemark));
    points=[]; currentIndex=0;

    input.value.split('\n').filter(l=>l.trim()).forEach((l,i)=>{
        const [lat,lon,rest]=l.split(',');
        const [az,text]=rest.split('-');
        const pm=new ymaps.Placemark([+lat,+lon],{},{
            iconLayout:'default#image',
            iconImageHref:arrowSVG(+az,'blue',i+1),
            iconImageSize:[36,36],
            iconImageOffset:[-18,-18]
        });
        map.geoObjects.add(pm);
        points.push({coords:[+lat,+lon], azimuth:+az, text, placemark:pm});
    });
    updateTargetArrow();
}

/* ===== TARGET COLOR ===== */
function updateTargetArrow(){
    points.forEach((p,i)=>{
        if(!p.placemark) return;
        p.placemark.options.set(
            'iconImageHref',
            arrowSVG(p.azimuth, i===currentIndex?'green':'blue', i+1)
        );
    });
}

/* ===== CHECK ===== */
function checkDistance(pos){
    if(!points[currentIndex]) return;
    const p=points[currentIndex];
    const dist=getDistance(pos[0],pos[1],p.coords[0],p.coords[1]);

    info.textContent=
        `№${currentIndex+1} | ${p.text} | `+
        `Расст: ${Math.round(dist)}м | Аз: ${azimuth}° | Цель: ${p.azimuth}°`;

    const dTrig=+distanceTrigger.value||20;
    const diff=Math.abs(((azimuth-p.azimuth+540)%360)-180);

    if(dist<=dTrig && diff<=45 && speechAllowed){
        speechSynthesis.speak(new SpeechSynthesisUtterance(p.text));
        map.geoObjects.remove(p.placemark);
        p.placemark=null;
        currentIndex++;
        updateTargetArrow();
    }
}

/* ===== DIST ===== */
function getDistance(a,b,c,d){
    const R=6371000;
    const dLat=(c-a)*Math.PI/180;
    const dLon=(d-b)*Math.PI/180;
    const x=Math.sin(dLat/2)**2+
        Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*
        Math.sin(dLon/2)**2;
    return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}
</script>
</body>
</html>
