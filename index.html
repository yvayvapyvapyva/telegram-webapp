<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>Навигация</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://api-maps.yandex.ru/2.1/?apikey=ВАШ_API_КЛЮЧ&lang=ru_RU"></script>

<style>
html,body{margin:0;height:100%;font-family:Arial}
#map{width:100%;height:100%}

#start{
    position:absolute;inset:0;z-index:20;
    background:black;color:white;
    display:flex;align-items:center;justify-content:center;
    font-size:20px;cursor:pointer
}

#togglePanelBtn{
    position:absolute;top:10px;left:10px;z-index:16;
    width:36px;height:36px;
    background:white;border:none;border-radius:6px;font-size:20px
}

#panel{
    position:absolute;top:50px;left:10px;z-index:15;
    width:300px;max-height:75%;
    background:rgba(255,255,255,.95);
    padding:6px;border-radius:6px;
    display:none;overflow:auto
}

#panel textarea{width:100%;height:220px}
#panel button,#panel input{width:100%;margin-top:5px}

#targets div{
    padding:6px;border-bottom:1px solid #ddd;cursor:pointer
}
#targets div.active{
    background:#c8f7c5;font-weight:bold
}

#info{
    position:absolute;bottom:0;left:0;width:100%;
    background:rgba(255,255,255,.95);
    padding:8px;font-weight:bold;z-index:15
}
</style>
</head>
<body>

<div id="start">Нажмите для запуска</div>
<button id="togglePanelBtn">☰</button>

<div id="panel">
<textarea id="input">
56.339941,43.933242,0-Параллельная парковка
56.340072,43.933019,90-Заезд в гараж
56.340182,43.932832,180-Выезд направо
</textarea>

<button onclick="showPoints()">Построить маршрут</button>

<label>Дистанция (м)</label>
<input id="distanceTrigger" type="number" value="20">

<button id="toggleAutoCenter">Автоцентр: Вкл</button>
<hr>
<div id="targets"></div>
</div>

<div id="info">Ожидание GPS…</div>
<div id="map"></div>

<script>
let map, userPlacemark;
let points=[], azimuth=0;
let autoCenter=true, speechAllowed=false;

/* START */
start.onclick=async()=>{
    start.remove();
    speechAllowed=true;
    speechSynthesis.speak(new SpeechSynthesisUtterance(''));
    if(DeviceOrientationEvent?.requestPermission)
        await DeviceOrientationEvent.requestPermission();
    initMap(); initCompass();
};

togglePanelBtn.onclick=()=>{
    panel.style.display=panel.style.display==='block'?'none':'block';
};

toggleAutoCenter.onclick=()=>{
    autoCenter=!autoCenter;
    toggleAutoCenter.textContent=`Автоцентр: ${autoCenter?'Вкл':'Выкл'}`;
};

/* MAP */
function initMap(){
    ymaps.ready(()=>{
        map=new ymaps.Map("map",{
            center:[0,0],zoom:18,type:'yandex#satellite',controls:[]
        });

        userPlacemark=new ymaps.Placemark([0,0],{},{
            iconLayout:'default#image',
            iconImageHref:arrowSVG(0,'red'),
            iconImageSize:[40,40],
            iconImageOffset:[-20,-20]
        });

        map.geoObjects.add(userPlacemark);

        navigator.geolocation.watchPosition(p=>{
            const c=[p.coords.latitude,p.coords.longitude];
            userPlacemark.geometry.setCoordinates(c);
            if(autoCenter) map.setCenter(c);
            checkDistance(c);
        },null,{enableHighAccuracy:true});
    });
}

/* COMPASS — FIXED */
function initCompass(){
    // iOS
    window.addEventListener('deviceorientation',e=>{
        if(e.webkitCompassHeading!==undefined){
            azimuth=Math.round(e.webkitCompassHeading);
            updateUserArrow();
        }
    },true);

    // Android
    window.addEventListener('deviceorientationabsolute',e=>{
        if(!e.absolute||e.alpha===null) return;
        azimuth=Math.round((360-e.alpha)%360);
        updateUserArrow();
    },true);
}

function updateUserArrow(){
    if(!userPlacemark) return;
    userPlacemark.options.set(
        'iconImageHref',
        arrowSVG(azimuth,'red')
    );
}

/* SVG */
function arrowSVG(a,color,num){
    return 'data:image/svg+xml;utf8,'+encodeURIComponent(`
<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40">
<g transform="rotate(${a},20,20)">
<polygon points="20,2 28,30 20,24 12,30" fill="${color}"/>
</g>
${num?`<text x="20" y="30" font-size="14" text-anchor="middle" fill="white">${num}</text>`:''}
</svg>`);
}

/* ROUTE */
function showPoints(){
    clearRoute();
    points=[];
    input.value.split('\n').filter(l=>l.trim()).forEach((l,i)=>{
        const [lat,lon,rest]=l.split(',');
        const [az,text]=rest.split('-');
        points.push({
            id:i+1,
            coords:[+lat,+lon],
            azimuth:+az,
            text,
            placemark:null
        });
    });
    rebuildRoute();
}

function rebuildRoute(){
    clearRoute();
    targets.innerHTML='';

    points.forEach((p,i)=>{
        p.placemark=new ymaps.Placemark(p.coords,{},{
            iconLayout:'default#image',
            iconImageHref:arrowSVG(p.azimuth,i===0?'green':'blue',p.id),
            iconImageSize:[36,36],
            iconImageOffset:[-18,-18]
        });
        map.geoObjects.add(p.placemark);

        const div=document.createElement('div');
        div.textContent=`${p.id}. ${p.text}`;
        if(i===0) div.classList.add('active');
        div.onclick=()=>selectAsFirst(i);
        targets.appendChild(div);
    });
}

function selectAsFirst(i){
    for(let j=0;j<i;j++)
        if(points[j].placemark)
            map.geoObjects.remove(points[j].placemark);
    points=points.slice(i);
    rebuildRoute();
}

/* CHECK */
function checkDistance(pos){
    if(!points.length) return;
    const p=points[0];
    const dist=getDistance(pos[0],pos[1],p.coords[0],p.coords[1]);
    const diff=Math.abs(((azimuth-p.azimuth+540)%360)-180);

    info.textContent=
        `№${p.id} | ${p.text} | ${Math.round(dist)}м | Аз:${azimuth}° | Ц:${p.azimuth}°`;

    if(dist<=(+distanceTrigger.value||20)&&diff<=45){
        speechSynthesis.speak(new SpeechSynthesisUtterance(p.text));
        map.geoObjects.remove(p.placemark);
        points.shift();
        rebuildRoute();
    }
}

/* UTILS */
function clearRoute(){
    if(!map) return;
    map.geoObjects.each(o=>{
        if(o!==userPlacemark) map.geoObjects.remove(o);
    });
}

function getDistance(a,b,c,d){
    const R=6371000;
    const dLat=(c-a)*Math.PI/180;
    const dLon=(d-b)*Math.PI/180;
    const x=Math.sin(dLat/2)**2+
        Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*
        Math.sin(dLon/2)**2;
    return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}
</script>
</body>
</html>
